#!/usr/bin/env node
/*
 *  Copyright 2011 Rackspace
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 */

var sys = require('sys');
var arg = require('optimist')
    .usage('$0 --source=[source] --target=[destination] [--re=REGEX]')
    .demand('target')
    .describe('target', 'cloudfiles://, directory://')
    .demand('source')
    .default('re', '.*-Data.db');
var argv = arg.argv;

function main() {
  var sync = require('../lib/cassandra-syncer').sync;
  /* TOOD: arg parsing */
//  var options = {'source': './test', 'target': 'cloudfiles://username:password'}
  var options = {};

  if (argv.help) {
    arg.showHelp();
    process.exit(0);
  }

  if (!argv.source) {
    process.stderr.write('Source not provided');
    process.exit(-1);
  }

  if (!argv.target) {
    process.stderr.write('Target not provided');
    process.exit(-1);
  }

  options.re = argv.re;
  options.source = argv.source;
  options.target = argv.target;

  sync(options, function(err) {
    if (err) {
      process.stderr.write(err);
      if (err.stack) {
        process.stderr.write(err.stack);
      }
    }
    process.exit(1);
  });
}

main();
